Kerjakuy db schema

V1

CREATE TABLE users (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name         VARCHAR(100) NOT NULL,
  email        VARCHAR(150) NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  avatar_url   TEXT,
  created_at   TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at   TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE workspaces (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name         VARCHAR(100) NOT NULL,
  slug         VARCHAR(100) NOT NULL UNIQUE, -- buat URL: /w/slug
  owner_id     UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
  plan         VARCHAR(50) NOT NULL DEFAULT 'free', -- free/standard/pro
  created_at   TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at   TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE workspace_members (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id  UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  user_id       UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role          VARCHAR(20) NOT NULL DEFAULT 'member', -- owner, admin, member
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE (workspace_id, user_id)
);

CREATE TABLE user_sessions (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id      UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token_hash   TEXT NOT NULL,
  user_agent   TEXT,
  ip_address   INET,
  expires_at   TIMESTAMP WITH TIME ZONE NOT NULL,
  created_at   TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

V2

CREATE TABLE projects (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id  UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  name          VARCHAR(150) NOT NULL,
  description   TEXT,
  color         VARCHAR(20),
  is_archived   BOOLEAN NOT NULL DEFAULT FALSE,
  created_by    UUID NOT NULL REFERENCES users(id),
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE boards (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id    UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  name          VARCHAR(150) NOT NULL,
  position      INTEGER NOT NULL DEFAULT 0,
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE columns (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  board_id      UUID NOT NULL REFERENCES boards(id) ON DELETE CASCADE,
  name          VARCHAR(100) NOT NULL,
  position      INTEGER NOT NULL DEFAULT 0,
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE tasks (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id  UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  project_id    UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  column_id     UUID NOT NULL REFERENCES columns(id) ON DELETE SET NULL,
  title         VARCHAR(200) NOT NULL,
  description   TEXT,
  position      INTEGER NOT NULL DEFAULT 0,
  priority      VARCHAR(20) DEFAULT 'medium', -- low/medium/high
  due_date      DATE,
  status        VARCHAR(20) DEFAULT 'open',   -- open/in_progress/done
  created_by    UUID NOT NULL REFERENCES users(id),
  completed_at  TIMESTAMP WITH TIME ZONE,
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE task_assignees (
  id        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id   UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  user_id   UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE (task_id, user_id)
);


V3

CREATE TABLE task_comments (
  id         UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id    UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  user_id    UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  content    TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE attachments (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id     UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  uploaded_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  file_name   VARCHAR(255) NOT NULL,
  file_url    TEXT NOT NULL,
  file_size   BIGINT,
  mime_type   VARCHAR(100),
  created_at  TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE activity_logs (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id  UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  project_id    UUID REFERENCES projects(id) ON DELETE CASCADE,
  user_id       UUID REFERENCES users(id),
  action        VARCHAR(100) NOT NULL,       -- e.g. task_moved, task_created
  target_type   VARCHAR(50) NOT NULL,        -- task, project, column
  target_id     UUID,
  metadata      JSONB,
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

V4

CREATE TABLE chat_channels (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id  UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  project_id    UUID REFERENCES projects(id) ON DELETE CASCADE,
  name          VARCHAR(100) NOT NULL,
  type          VARCHAR(20) NOT NULL DEFAULT 'group', -- group / direct
  created_by    UUID NOT NULL REFERENCES users(id),
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE chat_channel_members (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  channel_id   UUID NOT NULL REFERENCES chat_channels(id) ON DELETE CASCADE,
  user_id      UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  joined_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE (channel_id, user_id)
);

CREATE TABLE chat_messages (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  channel_id   UUID NOT NULL REFERENCES chat_channels(id) ON DELETE CASCADE,
  sender_id    UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  content      TEXT,
  reply_to_id  UUID REFERENCES chat_messages(id) ON DELETE SET NULL,
  created_at   TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE chat_message_reads (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  message_id  UUID NOT NULL REFERENCES chat_messages(id) ON DELETE CASCADE,
  user_id     UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  read_at     TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE (message_id, user_id)
);

V5

CREATE TABLE notifications (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id       UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  type          VARCHAR(50) NOT NULL,       -- task_assigned, comment_added, etc.
  title         VARCHAR(150) NOT NULL,
  body          TEXT,
  data          JSONB,
  is_read       BOOLEAN NOT NULL DEFAULT FALSE,
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);


| Tabel             | Index Wajib                                                                                                                             |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| users             | email                                                                                                                                   |
| workspaces        | owner_id, slug                                                                                                                          |
| workspace_members | workspace_id, user_id, (workspace_id, user_id)                                                                                          |
| projects          | workspace_id, created_by, (workspace_id, created_at)                                                                                    |
| task_statuses     | project_id                                                                                                                              |
| tasks             | project_id, workspace_id, status_id, created_by, updated_by, due_date, created_at, (workspace_id, project_id), (project_id, created_at) |
| task_assignees    | task_id, user_id, (task_id, user_id)                                                                                                    |
| task_comments     | task_id, user_id, created_at                                                                                                            |
| attachments       | task_id, uploaded_by                                                                                                                    |
| activity_logs     | workspace_id, project_id, task_id, user_id, created_at, (workspace_id, created_at)                                                      |


curl -i -X POST http://localhost:8080/api/v1/workspaces \
  -H "Authorization: Bearer eyJ1aWQiOiI5NDNjNWM0NC01Y2UxLTRlNmMtODk5NC05ZWUxNWM5YjBmN2QiLCJlbWFpbCI6ImR3aXByYXN0MTNAZ21haWwuY29tIiwiaXNzIjoia2VyamFrdXkiLCJ0eXAiOiJhY2Nlc3MiLCJpYXQiOjE3NjM2MTMxNjIsImV4cCI6MTc2MzYxNDA2Mn0.tQ0Xo5SjeA1lXFoDSM0l4FokxTY08UIq1kdsaql2d54" \
  -H "Content-Type: application/json" \
  -d '{"name":"Workspace Demo","slug":"workspace-demo","plan":"free"}'

